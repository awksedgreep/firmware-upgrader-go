<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Activity & Upgrade Logs - Firmware Upgrader</title>
        <link rel="stylesheet" href="/shared.css" />
        <style>
            .filters-section {
                background-color: var(--surface);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-lg);
                padding: var(--spacing-lg);
                margin-bottom: var(--spacing-xl);
            }

            .filter-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: var(--spacing-md);
                margin-bottom: var(--spacing-md);
            }

            .filter-actions {
                display: flex;
                gap: var(--spacing-md);
                justify-content: flex-end;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: var(--spacing-lg);
                margin-bottom: var(--spacing-xl);
            }

            .stat-card {
                background-color: var(--surface);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-lg);
                padding: var(--spacing-lg);
                text-align: center;
            }

            .stat-value {
                font-size: 2.5em;
                font-weight: 700;
                margin: var(--spacing-md) 0;
            }

            .stat-value.success {
                color: var(--success-color);
            }

            .stat-value.pending {
                color: var(--warning-color);
            }

            .stat-value.failed {
                color: var(--danger-color);
            }

            .stat-value.total {
                color: var(--primary-color);
            }

            .stat-label {
                font-size: 0.9em;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .tabs {
                display: flex;
                gap: var(--spacing-sm);
                border-bottom: 2px solid var(--border-color);
                margin-bottom: var(--spacing-xl);
            }

            .tab {
                padding: var(--spacing-md) var(--spacing-lg);
                background: none;
                border: none;
                color: var(--text-secondary);
                cursor: pointer;
                font-weight: 600;
                border-bottom: 3px solid transparent;
                transition: all 0.2s ease;
            }

            .tab:hover {
                color: var(--primary-color);
            }

            .tab.active {
                color: var(--primary-color);
                border-bottom-color: var(--primary-color);
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .log-section {
                background-color: var(--surface);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-lg);
                padding: var(--spacing-xl);
            }

            .timeline {
                position: relative;
                padding-left: var(--spacing-xl);
            }

            .timeline::before {
                content: "";
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 2px;
                background: var(--border-color);
            }

            .timeline-item {
                position: relative;
                padding-bottom: var(--spacing-xl);
                padding-left: var(--spacing-xl);
            }

            .timeline-item::before {
                content: "";
                position: absolute;
                left: -6px;
                top: 4px;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: var(--primary-color);
                border: 2px solid var(--surface);
            }

            .timeline-item.success::before {
                background: var(--success-color);
            }

            .timeline-item.failed::before {
                background: var(--danger-color);
            }

            .timeline-item.pending::before {
                background: var(--warning-color);
            }

            .timeline-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: var(--spacing-sm);
            }

            .timeline-title {
                font-weight: 600;
                font-size: 1.1em;
            }

            .timeline-time {
                font-size: 0.85em;
                color: var(--text-secondary);
            }

            .timeline-content {
                background-color: var(--background);
                padding: var(--spacing-md);
                border-radius: var(--radius-md);
                margin-top: var(--spacing-sm);
            }

            .timeline-meta {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: var(--spacing-md);
                font-size: 0.9em;
            }

            .timeline-meta-item {
                display: flex;
                flex-direction: column;
            }

            .timeline-meta-label {
                color: var(--text-secondary);
                font-size: 0.85em;
                margin-bottom: var(--spacing-xs);
            }

            .timeline-meta-value {
                font-weight: 600;
            }

            .job-details {
                background-color: var(--background);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-md);
                padding: var(--spacing-md);
                margin-top: var(--spacing-md);
            }

            .job-detail-row {
                display: flex;
                justify-content: space-between;
                padding: var(--spacing-sm) 0;
                border-bottom: 1px solid var(--border-color);
            }

            .job-detail-row:last-child {
                border-bottom: none;
            }

            .job-detail-label {
                color: var(--text-secondary);
                font-size: 0.9em;
            }

            .job-detail-value {
                font-weight: 600;
            }

            .job-actions {
                display: flex;
                gap: var(--spacing-sm);
                margin-top: var(--spacing-md);
            }

            .empty-state {
                text-align: center;
                padding: var(--spacing-xl) * 2;
                color: var(--text-secondary);
            }

            .empty-state-icon {
                font-size: 4em;
                margin-bottom: var(--spacing-lg);
                opacity: 0.5;
            }

            .refresh-indicator {
                display: inline-flex;
                align-items: center;
                gap: var(--spacing-sm);
                padding: var(--spacing-sm) var(--spacing-md);
                background-color: var(--background);
                border-radius: var(--radius-md);
                font-size: 0.85em;
                color: var(--text-secondary);
            }

            .table-wrapper {
                overflow-x: auto;
            }

            .progress-bar {
                height: 8px;
                background-color: var(--border-color);
                border-radius: 4px;
                overflow: hidden;
                margin-top: var(--spacing-sm);
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(
                    90deg,
                    var(--primary-color),
                    var(--success-color)
                );
                transition: width 0.3s ease;
            }

            .error-message {
                background-color: rgba(255, 59, 48, 0.1);
                border-left: 3px solid var(--danger-color);
                padding: var(--spacing-md);
                border-radius: var(--radius-sm);
                margin-top: var(--spacing-sm);
                font-size: 0.9em;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            .live-indicator {
                display: inline-block;
                width: 8px;
                height: 8px;
                background-color: var(--success-color);
                border-radius: 50%;
                animation: pulse 2s infinite;
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <header>
            <div class="header-container">
                <a href="/" class="header-brand"> üì° Firmware Upgrader </a>
                <nav>
                    <ul class="header-nav">
                        <li><a href="/">Dashboard</a></li>
                        <li><a href="/cmts.html">CMTS</a></li>
                        <li><a href="/rules.html">Rules</a></li>
                        <li><a href="/activity.html">Activity</a></li>
                        <li><a href="/settings.html">Settings</a></li>
                        <li><a href="/docs.html">Docs</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header flex-between">
                <div>
                    <h1 class="page-title">Activity & Upgrade Logs</h1>
                    <p class="page-subtitle">
                        Monitor firmware upgrade jobs and system activity
                    </p>
                </div>
                <div class="refresh-indicator">
                    <span class="live-indicator"></span>
                    <span>Auto-refresh enabled</span>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Jobs</div>
                    <div class="stat-value total" id="stat-total">0</div>
                    <div class="progress-bar">
                        <div
                            class="progress-fill"
                            id="progress-total"
                            style="width: 0%"
                        ></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value success" id="stat-completed">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pending</div>
                    <div class="stat-value pending" id="stat-pending">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Failed</div>
                    <div class="stat-value failed" id="stat-failed">0</div>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="filters-section">
                <h3 style="margin-bottom: var(--spacing-lg)">Filters</h3>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="filter-status">Status</label>
                        <select id="filter-status">
                            <option value="">All Statuses</option>
                            <option value="PENDING">Pending</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="FAILED">Failed</option>
                            <option value="SKIPPED">Skipped</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-event">Event Type</label>
                        <select id="filter-event">
                            <option value="">All Events</option>
                            <option value="MODEM_DISCOVERED">
                                Modem Discovered
                            </option>
                            <option value="UPGRADE_STARTED">
                                Upgrade Started
                            </option>
                            <option value="UPGRADE_COMPLETED">
                                Upgrade Completed
                            </option>
                            <option value="UPGRADE_FAILED">
                                Upgrade Failed
                            </option>
                            <option value="RULE_UPDATED">Rule Updated</option>
                            <option value="CMTS_ADDED">CMTS Added</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-limit">Items per page</label>
                        <select id="filter-limit">
                            <option value="20">20</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button
                        class="secondary"
                        onclick="clearFilters()"
                        type="button"
                    >
                        Clear Filters
                    </button>
                    <button
                        class="primary"
                        onclick="applyFilters()"
                        type="button"
                    >
                        Apply Filters
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="jobs">Upgrade Jobs</button>
                <button class="tab" data-tab="activity">Activity Log</button>
                <button class="tab" data-tab="timeline">Timeline View</button>
            </div>

            <!-- Upgrade Jobs Tab -->
            <div id="tab-jobs" class="tab-content active">
                <div class="log-section">
                    <h2 class="section-title">Upgrade Jobs</h2>
                    <div class="table-wrapper">
                        <table id="jobs-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Modem MAC</th>
                                    <th>Rule</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Started</th>
                                    <th>Completed</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" style="text-align: center">
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Activity Log Tab -->
            <div id="tab-activity" class="tab-content">
                <div class="log-section">
                    <h2 class="section-title">Activity Log</h2>
                    <div class="table-wrapper">
                        <table id="activity-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Event Type</th>
                                    <th>Entity</th>
                                    <th>Message</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center">
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Timeline View Tab -->
            <div id="tab-timeline" class="tab-content">
                <div class="log-section">
                    <h2 class="section-title">Timeline View</h2>
                    <div id="timeline-container" class="timeline">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚è≥</div>
                            <p>Loading timeline...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer>
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Product</h3>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href="/cmts.html">CMTS Management</a></li>
                        <li><a href="/rules.html">Rules Management</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Resources</h3>
                    <ul>
                        <li><a href="/docs.html">Documentation</a></li>
                        <li><a href="/api.html">API Reference</a></li>
                        <li><a href="/settings.html">Settings</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>System</h3>
                    <ul>
                        <li><a href="/activity.html">Activity Log</a></li>
                        <li><a href="/settings.html">Settings</a></li>
                        <li><a href="/">Dashboard</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Firmware Upgrader. All rights reserved.</p>
            </div>
        </footer>

        <!-- Scripts -->
        <script src="/shared.js"></script>
        <script>
            let refreshInterval;
            let currentFilters = {
                status: "",
                event: "",
                limit: 50,
            };

            // Tab switching
            document.querySelectorAll(".tab").forEach((tab) => {
                tab.addEventListener("click", () => {
                    const tabName = tab.dataset.tab;

                    // Update active tab
                    document
                        .querySelectorAll(".tab")
                        .forEach((t) => t.classList.remove("active"));
                    tab.classList.add("active");

                    // Update active content
                    document
                        .querySelectorAll(".tab-content")
                        .forEach((c) => c.classList.remove("active"));
                    document
                        .getElementById(`tab-${tabName}`)
                        .classList.add("active");

                    // Load data for the tab
                    if (tabName === "jobs") loadJobs();
                    else if (tabName === "activity") loadActivityLog();
                    else if (tabName === "timeline") loadTimeline();
                });
            });

            // Load statistics
            async function loadStats() {
                try {
                    const jobs = await apiGet("/api/jobs");

                    if (!jobs || jobs.length === 0) {
                        document.getElementById("stat-total").textContent = "0";
                        document.getElementById("stat-completed").textContent =
                            "0";
                        document.getElementById("stat-pending").textContent =
                            "0";
                        document.getElementById("stat-failed").textContent =
                            "0";
                        return;
                    }

                    const total = jobs.length;
                    const completed = jobs.filter(
                        (j) => j.status === "COMPLETED",
                    ).length;
                    const pending = jobs.filter((j) =>
                        ["PENDING", "IN_PROGRESS"].includes(j.status),
                    ).length;
                    const failed = jobs.filter(
                        (j) => j.status === "FAILED",
                    ).length;

                    document.getElementById("stat-total").textContent = total;
                    document.getElementById("stat-completed").textContent =
                        completed;
                    document.getElementById("stat-pending").textContent =
                        pending;
                    document.getElementById("stat-failed").textContent = failed;

                    // Update progress bar
                    const completionRate =
                        total > 0 ? (completed / total) * 100 : 0;
                    document.getElementById("progress-total").style.width =
                        completionRate + "%";
                } catch (error) {
                    console.error("Failed to load stats:", error);
                }
            }

            // Load upgrade jobs
            async function loadJobs() {
                const tbody = document.querySelector("#jobs-table tbody");
                try {
                    const jobs = await apiGet("/api/jobs");

                    tbody.innerHTML = "";

                    if (!jobs || jobs.length === 0) {
                        tbody.innerHTML =
                            '<tr><td colspan="8" class="empty-state">No upgrade jobs found</td></tr>';
                        return;
                    }

                    jobs.forEach((job) => {
                        const statusClass = getStatusClass(job.status);
                        const progress = getJobProgress(job);
                        const row = document.createElement("tr");

                        row.innerHTML = `
                            <td>${job.id}</td>
                            <td><code>${job.mac_address || "N/A"}</code></td>
                            <td>${job.rule_id || "N/A"}</td>
                            <td><span class="status-badge ${statusClass}">${job.status}</span></td>
                            <td>
                                <div class="progress-bar" style="width: 100px;">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                            </td>
                            <td>${job.started_at ? formatRelativeTime(job.started_at) : "-"}</td>
                            <td>${job.completed_at ? formatRelativeTime(job.completed_at) : "-"}</td>
                            <td>
                                <div class="action-links">
                                    <a href="#" onclick="viewJobDetails(${job.id}); return false;">View</a>
                                    ${
                                        job.status === "FAILED"
                                            ? `<a href="#" onclick="retryJob(${job.id}); return false;">Retry</a>`
                                            : ""
                                    }
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } catch (error) {
                    console.error("Failed to load jobs:", error);
                    tbody.innerHTML =
                        '<tr><td colspan="8" style="color: red; text-align: center;">Error loading jobs</td></tr>';
                }
            }

            // Load activity log
            async function loadActivityLog() {
                const tbody = document.querySelector("#activity-table tbody");
                try {
                    const limit = currentFilters.limit || 50;
                    const activities = await apiGet(
                        `/api/activity-log?limit=${limit}`,
                    );

                    tbody.innerHTML = "";

                    if (!activities || activities.length === 0) {
                        tbody.innerHTML =
                            '<tr><td colspan="5" class="empty-state">No activity logged yet</td></tr>';
                        return;
                    }

                    activities.forEach((activity) => {
                        const row = document.createElement("tr");
                        const eventClass = getEventClass(activity.event_type);

                        row.innerHTML = `
                            <td>${formatRelativeTime(activity.created_at)}</td>
                            <td><span class="status-badge ${eventClass}">${activity.event_type || "EVENT"}</span></td>
                            <td>${activity.entity_type || "-"} #${activity.entity_id || "-"}</td>
                            <td>${activity.message || "No message"}</td>
                            <td>
                                ${
                                    activity.details
                                        ? `<a href="#" onclick="alert('${escapeHtml(activity.details)}'); return false;">View</a>`
                                        : "-"
                                }
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } catch (error) {
                    console.error("Failed to load activity log:", error);
                    tbody.innerHTML =
                        '<tr><td colspan="5" style="color: red; text-align: center;">Error loading activity log</td></tr>';
                }
            }

            // Load timeline view
            async function loadTimeline() {
                const container = document.getElementById("timeline-container");
                try {
                    const [jobs, activities] = await Promise.all([
                        apiGet("/api/jobs"),
                        apiGet("/api/activity-log?limit=30"),
                    ]);

                    container.innerHTML = "";

                    // Combine and sort by timestamp
                    const events = [
                        ...(jobs || []).map((j) => ({
                            type: "job",
                            data: j,
                            timestamp: j.created_at,
                        })),
                        ...(activities || []).map((a) => ({
                            type: "activity",
                            data: a,
                            timestamp: a.created_at,
                        })),
                    ].sort((a, b) => b.timestamp - a.timestamp);

                    if (events.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <p>No events to display</p>
                            </div>
                        `;
                        return;
                    }

                    events.forEach((event) => {
                        const item = document.createElement("div");
                        item.className = `timeline-item ${
                            event.type === "job"
                                ? getStatusClass(event.data.status)
                                : "info"
                        }`;

                        if (event.type === "job") {
                            const job = event.data;
                            item.innerHTML = `
                                <div class="timeline-header">
                                    <div class="timeline-title">Upgrade Job #${job.id}</div>
                                    <div class="timeline-time">${formatRelativeTime(job.created_at)}</div>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-meta">
                                        <div class="timeline-meta-item">
                                            <div class="timeline-meta-label">Modem MAC</div>
                                            <div class="timeline-meta-value"><code>${job.mac_address || "N/A"}</code></div>
                                        </div>
                                        <div class="timeline-meta-item">
                                            <div class="timeline-meta-label">Status</div>
                                            <div class="timeline-meta-value">
                                                <span class="status-badge ${getStatusClass(job.status)}">${job.status}</span>
                                            </div>
                                        </div>
                                        <div class="timeline-meta-item">
                                            <div class="timeline-meta-label">Firmware</div>
                                            <div class="timeline-meta-value">${job.firmware_url || "N/A"}</div>
                                        </div>
                                        <div class="timeline-meta-item">
                                            <div class="timeline-meta-label">Retries</div>
                                            <div class="timeline-meta-value">${job.retry_count}/${job.max_retries}</div>
                                        </div>
                                    </div>
                                    ${
                                        job.error_message
                                            ? `<div class="error-message">${job.error_message}</div>`
                                            : ""
                                    }
                                </div>
                            `;
                        } else {
                            const activity = event.data;
                            item.innerHTML = `
                                <div class="timeline-header">
                                    <div class="timeline-title">${activity.event_type || "System Event"}</div>
                                    <div class="timeline-time">${formatRelativeTime(activity.created_at)}</div>
                                </div>
                                <div class="timeline-content">
                                    <p>${activity.message || "No message"}</p>
                                    ${
                                        activity.details
                                            ? `<div style="margin-top: var(--spacing-sm); font-size: 0.9em; color: var(--text-secondary);">${activity.details}</div>`
                                            : ""
                                    }
                                </div>
                            `;
                        }

                        container.appendChild(item);
                    });
                } catch (error) {
                    console.error("Failed to load timeline:", error);
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ùå</div>
                            <p>Error loading timeline</p>
                        </div>
                    `;
                }
            }

            // Helper functions
            function getStatusClass(status) {
                const statusMap = {
                    COMPLETED: "success",
                    PENDING: "pending",
                    IN_PROGRESS: "pending",
                    FAILED: "failed",
                    SKIPPED: "disabled",
                };
                return statusMap[status] || "info";
            }

            function getEventClass(eventType) {
                if (!eventType) return "info";
                if (eventType.includes("COMPLETED")) return "success";
                if (eventType.includes("FAILED") || eventType.includes("ERROR"))
                    return "failed";
                if (
                    eventType.includes("STARTED") ||
                    eventType.includes("PENDING")
                )
                    return "pending";
                return "info";
            }

            function getJobProgress(job) {
                if (job.status === "COMPLETED") return 100;
                if (job.status === "IN_PROGRESS") return 50;
                if (job.status === "PENDING") return 10;
                if (job.status === "FAILED") return 100;
                return 0;
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            // View job details
            function viewJobDetails(jobId) {
                alert(
                    `Job details view coming soon!\nJob ID: ${jobId}\n\nThis will show:\n- Full job information\n- Modem details\n- Firmware information\n- Execution logs\n- Retry history`,
                );
            }

            // Retry job
            async function retryJob(jobId) {
                if (
                    !confirm(
                        `Are you sure you want to retry upgrade job #${jobId}?`,
                    )
                )
                    return;

                try {
                    await apiPost(`/api/jobs/${jobId}/retry`, {});
                    alert("Job queued for retry");
                    loadJobs();
                    loadStats();
                } catch (error) {
                    alert(`Error retrying job: ${error.message}`);
                }
            }

            // Filter functions
            function applyFilters() {
                currentFilters.status =
                    document.getElementById("filter-status").value;
                currentFilters.event =
                    document.getElementById("filter-event").value;
                currentFilters.limit = parseInt(
                    document.getElementById("filter-limit").value,
                );

                // Reload current tab
                const activeTab =
                    document.querySelector(".tab.active").dataset.tab;
                if (activeTab === "jobs") loadJobs();
                else if (activeTab === "activity") loadActivityLog();
                else if (activeTab === "timeline") loadTimeline();
            }

            function clearFilters() {
                document.getElementById("filter-status").value = "";
                document.getElementById("filter-event").value = "";
                document.getElementById("filter-limit").value = "50";
                currentFilters = { status: "", event: "", limit: 50 };
                applyFilters();
            }

            // Auto-refresh every 10 seconds
            function startAutoRefresh() {
                refreshInterval = setInterval(() => {
                    loadStats();
                    const activeTab =
                        document.querySelector(".tab.active").dataset.tab;
                    if (activeTab === "jobs") loadJobs();
                    else if (activeTab === "activity") loadActivityLog();
                    else if (activeTab === "timeline") loadTimeline();
                }, 10000);
            }

            function stopAutoRefresh() {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            }

            // Initialize on page load
            document.addEventListener("DOMContentLoaded", () => {
                loadStats();
                loadJobs();
                startAutoRefresh();
            });

            // Stop refresh when leaving page
            window.addEventListener("beforeunload", stopAutoRefresh);
        </script>
    </body>
</html>
